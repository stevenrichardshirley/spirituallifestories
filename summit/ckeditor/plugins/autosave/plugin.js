/*
Copyright (c) 2003-2011, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

(function(){var a=0,b=0,c=false,d=false,e=false,f='',g='',h='',i='',j='',k=true,l='',m=false,n=/^form$|^body$/i,o=/^form$/i,p=(function(){var D=null,E=function(L,M){if(!M){t(L,f[5].path,f[5].title+L.lang.autosave.noUrl);window.clearTimeout(i);i=CKEDITOR.tools.setTimeout(t,5000,null,[L,f[1].path,f[1].title]);throw new Error(L.lang.autosave.noUrl);}D=L;},F=(function(){var L=[function(){return{xhr:new XMLHttpRequest(),xhrTimeout:false};},function(){return{xhr:new ActiveXObject('Msxml2.XMLHTTP'),xhrTimeout:false};},function(){return{xhr:new ActiveXObject('Microsoft.XMLHTTP'),xhrTimeout:false};}];for(var M=0,N=L.length;M<N;M++){try{L[M]();}catch(O){continue;}F=L[M];return L[M];}throw new Error(D.lang.autosave.noXhr);})(),G=function(L){var M=L.split('?')[1];if(!M)return L;var N=H(M);L=L.replace(/\?.*/,'?'+N);return L;},H=function(L){var M=L.split('&'),N='';for(var O=0,P=M.length;O<P;O++){if(M[O].substring(0,M[O].indexOf('='))!=D.config.autosaveContentParamName)M[O]=M[O].replace(/\=.*/,'='+encodeURIComponent(M[O].substring(M[O].indexOf('=')+1)));N+=(O===0?'':'&')+M[O];}return N;},I=function(L,M){var N='';N=D.lang.autosave['error'+L];if(!N)if(M)N='('+L+') '+M;else N=D.lang.autosave.defaultErrorMessage.replace(/(###)/,L);t(D,f[5].path,f[5].title+N);},J=function(){var L=new Date(),M=L.getHours(),N=L.getMinutes(),O=L.getSeconds();if(M<10)M='0'+M;if(N<10)N='0'+N;if(O<10)O='0'+O;return M+':'+N+':'+O;},K=function(L,M){if(L)return M?f[1].path:f[0].path;else return M?f[1].title:f[0].title+h;};return{request:function(L,M,N,O){E(L,N);var P=F();P.xhr.onreadystatechange=function(){P.xhrTimeout=false;if(D.config.autosaveRequestTimeout)if(P.xhr.readyState==1)j=window.setTimeout(function(){if(P.xhr.readyState==1||P.xhr.readyState==2&&CKEDITOR.env.opera){P.xhr.abort();P.xhrTimeout=true;t(D,f[5].path,f[5].title+D.lang.autosave.requestTimeout);window.clearTimeout(i);i=CKEDITOR.tools.setTimeout(w,10000,null,[D,K(true,b),K(false,b)]);e=false;if(b)a+=b;}},D.config.autosaveRequestTimeout*1000);if(P.xhr.readyState==4&&!P.xhrTimeout){if(P.xhr.status>=200&&P.xhr.status<300||P.xhr.status==304||P.xhr.status===0||P.xhr.status==1223){if(D.config.autosaveRequestTimeout)window.clearTimeout(j);var Q='',R='';if(P.xhr.responseXML){Q=P.xhr.responseXML.getElementsByTagName('result')[0];R=P.xhr.responseXML.getElementsByTagName('error')[0];}if(Q&&Q.attributes.getNamedItem('status')&&Q.attributes.getNamedItem('status').value=='ok'){h=J();t(D,f[4].path,f[4].title+h);window.clearTimeout(i);i=CKEDITOR.tools.setTimeout(w,5000,null,[D,f[0].path,f[0].title+h]);
b=0;}else if(R&&(R.attributes.getNamedItem('statuscode')&&R.attributes.getNamedItem('statuscode').value||R.attributes.getNamedItem('message')&&R.attributes.getNamedItem('message').value)){if(R.attributes.getNamedItem('message')&&R.attributes.getNamedItem('message').value)t(D,f[5].path,f[5].title+R.attributes.getNamedItem('message').value);else I(R.attributes.getNamedItem('statuscode').value);window.clearTimeout(i);i=CKEDITOR.tools.setTimeout(w,10000,null,[D,K(true,b),K(false,b)]);}else{t(D,f[5].path,f[5].title+(P.xhr.responseText?P.xhr.responseText:P.xhr.status?D.lang.autosave.defaultErrorMessage.replace(/(###)/,P.xhr.status):D.lang.autosave.unknownError));window.clearTimeout(i);i=CKEDITOR.tools.setTimeout(w,10000,null,[D,K(true,b),K(false,b)]);}}else{I(P.xhr.status,P.xhr.responseText);window.clearTimeout(i);i=CKEDITOR.tools.setTimeout(w,10000,null,[D,K(true,b),K(false,b)]);}e=false;if(b)a+=b;L.fire('afterAutosave');}};if(M=='GET'){N=N.indexOf('?')>0?N+'&'+O:N+'?'+O;N=G(N);O=null;}P.xhr.open(M,N,true);if(M=='POST'){P.xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=UTF-8');O=H(O);}L.fire('beforeAutosave');P.xhr.send(O);}};})();function q(D){if(D.checkDirty()){a++;D.resetDirty();t(D,f[1].path,f[1].title);}if(!e){e=true;if(c||d){if(d){d=false;if(a>0&&k)r(D);else e=false;}else{c=false;r(D);}}else if(D.config.autosaveSensitivity&&a>=D.config.autosaveSensitivity){if(k){window.clearTimeout(l);k=false;r(D);}else e=false;}else{e=false;if(!D.config.autosaveSensitivity&&!D.config.autosaveRefreshTime)a=0;}}if(c)c=false;};function r(D){var E=D.getData();b=a;a=0;s(D,E);};function s(D,E){t(D,f[3].path,f[3].title);v(D,false);p.request(D,D.config.autosaveMethod,D.config.autosaveTargetUrl,D.config.autosaveRequestParams+'autosaveaction=draft&ckeditorname='+D.name+'&'+D.config.autosaveContentParamName+'='+encodeURIComponent(E));window.clearTimeout(l);k=false;l=window.setTimeout(function(){k=true;},D.config.autosaveMinTimeBetweenRequests*1000);};function t(D,E,F){var G=CKEDITOR.document.getById(D._.commands.autosave.uiItems[0]._.id);G.getFirst().setStyle('background-image','url('+D.plugins.autosave.path+E+')');G.setAttribute('title',F);G.getChild(1).setHtml(F);};function u(D,E){return D.indexOf(E,D.length-E.length)!==-1;};function v(D,E){if(D.config.autosaveRequestParams){var F=D.config.autosaveRequestParams,G='&';while(F&&F.indexOf(G)===0)F=F.length===1?'':F.substring(1);if(E)while(F&&u(F,G))F=F.substring(0,F.length-1);if(F&&!u(F,G))F+='&';D.config.autosaveRequestParams=F;
}};function w(D,E,F){if(a===b&&!e&&!D.checkDirty())t(D,E,F);};function x(D,E,F){if(D.addEventListener)D.addEventListener(E,F,false);else if(D.attachEvent)D.attachEvent('on'+E,F);};function y(D){e=true;D.config.autosaveUseOnBeforeUnload=false;window.clearInterval(g);window.clearTimeout(i);window.clearTimeout(l);return true;};function z(D,E){if(!E)E=document.getElementsByTagName('body')[0];var F='',G=new RegExp('\\b'+D+'\\b'),H=E.getElementsByTagName('*');for(var I=0,J=H.length;I<J;I++){if(G.test(H[I].className)){F=H[I];break;}}return F;};function A(D,E){var F=D.length;while(F--){if(D[F][0]===E)return true;}return false;};function B(D){if(!n.test(D.nodeName))return B(D.parentNode);else if(o.test(D.nodeName))return D;else return null;};function C(D,E){if(D.config.autosaveKeystroke&&m)if(E.data.getKeystroke()===D.config.autosaveKeystroke){c=true;D.execCommand('autosave');return;}if(E.data.$.ctrlKey||E.data.$.metaKey)return;var F=E.data.$.keyCode;if(F==8||F==13||F==32||F>=46&&F<=90||F>=96&&F<=111||F>=186&&F<=222)window.setTimeout(function(){q(D);},100);};CKEDITOR.plugins.add('autosave',{lang:['en','pl'],init:function(D){D.on('pluginsLoaded',function(E){if(D.config.autosaveKeystroke){var F=D.config.autosaveKeystroke;if(!A(D.config.keystrokes,F)&&!D.keystrokeHandler.keystrokes[F]){D.config.keystrokes.push([F,'autosave']);D.keystrokeHandler.keystrokes[F]='autosave';m=true;}}});D.on('instanceReady',function(E){if(D.config.autosaveRefreshTime&&parseInt(D.config.autosaveRefreshTime,10)<parseInt(D.config.autosaveMinTimeBetweenRequests,10))D.config.autosaveRefreshTime=D.config.autosaveMinTimeBetweenRequests;v(D,true);D.on('saveSnapshot',function(){if(!E.data||!E.data.contentOnly)q(D);});D.on('beforeCommandExec',function(I){if(I.data.name=='save')y(D);});D.getCommand('undo').on('afterUndo',function(){q(D);});D.getCommand('redo').on('afterRedo',function(){q(D);});D.on('contentDom',function(I){D.document.on('keydown',function(J){C(D,J);});D.document.on('drop',function(){q(D);});D.document.getBody().on('drop',function(){q(D);});});D.fire('contentDom');D.on('mode',function(I){if(D.mode!='source')return;D.textarea.on('keydown',function(J){C(D,J);});D.textarea.on('drop',function(){q(D);});D.textarea.on('input',function(){q(D);});});D.on('afterCommandExec',function(I){if(I.data.name=='source')return;if(I.data.command.canUndo!==false)q(D);});E.editor.on('destroy',function(I){window.clearInterval(g);window.clearTimeout(i);window.clearTimeout(l);});if(D.config.autosaveParentFormId&&document.getElementById(D.config.autosaveParentFormId)){var F=document.getElementById(D.config.autosaveParentFormId);
x(F,'submit',function(){y(D);});}else{var G=z(D.id);if(G){var H=B(G);if(H)x(H,'submit',function(){y(D);});}}if(D.config.autosaveUseOnBeforeUnload)window.onbeforeunload=function(){if(D.config.autosaveUseOnBeforeUnload)if(a>0||e)return D.lang.autosave.looseChanges;};if(D.config.autosaveRefreshTime&&!parseInt(D.config.autosaveRefreshTime,10)<1)g=window.setInterval(function(){d=true;q(D);},D.config.autosaveRefreshTime*1000);window.onunload=function(){window.clearInterval(g);window.clearTimeout(i);window.clearTimeout(l);window.onbeforeunload=null;};});f=[{path:'images/autosaveClean.gif',title:D.lang.autosave.draftSaved},{path:'images/autosaveDirty.gif',title:D.lang.autosave.needsSaving},{path:'images/loadingBig.gif',title:D.lang.autosave.inProgress},{path:'images/loadingSmall.gif',title:D.lang.autosave.inProgress},{path:'images/tick_animated.gif',title:D.lang.autosave.draftSaved},{path:'images/cross_animated.gif',title:D.lang.autosave.errorTemplate}];D.addCommand('autosave',{modes:{wysiwyg:1,source:1},canUndo:false,exec:function(E){q(E);}});D.ui.addButton('Autosave',{label:D.lang.autosave.defaultMessage,command:'autosave',click:function(E){c=true;E.execCommand('autosave');},icon:this.path+'images/autosaveClean.gif'});}});})();CKEDITOR.tools.extend(CKEDITOR.config,{autosaveSensitivity:20,autosaveRefreshTime:30,autosaveUseOnBeforeUnload:true,autosaveTargetUrl:'',autosaveParentFormId:'',autosaveMethod:'POST',autosaveContentParamName:'content',autosaveRequestParams:'',autosaveKeystroke:'',autosaveRequestTimeout:10,autosaveMinTimeBetweenRequests:15});
